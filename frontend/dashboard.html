<!--
    ***** BEGIN LICENSE BLOCK *****
    Version: MPL 1.1

    The contents of this file are subject to the Mozilla Public License Version
    1.1 (the "License"); you may not use this file except in compliance with
    the License. You may obtain a copy of the License at
    http://www.mozilla.org/MPL/

    Software distributed under the License is distributed on an "AS IS" basis,
    WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
    for the specific language governing rights and limitations under the
    License.

    The Original Code is Bespin.

    The Initial Developer of the Original Code is Mozilla.
    Portions created by the Initial Developer are Copyright (C) 2009
    the Initial Developer. All Rights Reserved.

    Contributor(s):
        Bespin Team (bespin@mozilla.com)

    ***** END LICENSE BLOCK *****
-->

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>gtk test</title>
    <link type="text/css" rel="stylesheet" href="css/dashboard.css"/>
    <script type="text/javascript" src="js/external/prototype-1.6.0.3.js"></script>
    <script type="text/javascript" src="js/util/path.js"></script>
    <script type="text/javascript" src="js/client/server.js"></script>

    <script type="text/javascript" src="js/external/jstraits.js"></script>
    <script type="text/javascript" src="js/th/array_utils.js"></script>
    <script type="text/javascript" src="js/th/traits.js"></script>
    <script type="text/javascript" src="js/th/gtk.js"></script>
    <script type="text/javascript" src="js/th/models.js"></script>
    <script type="text/javascript" src="js/th/borders.js"></script>
    <script type="text/javascript" src="js/th/components.js"></script>
    <script type="text/javascript" src="js/client/dashboard.js"></script>
    <script type="text/javascript">
        var heightDiff;
        var projects;
        var scene;
        var tree;
        var infoPanel;

        function sizeCanvas(canvas) {
            if (!heightDiff) {
                heightDiff = $("header").clientHeight + $("subheader").clientHeight + $("footer").clientHeight;
            }
            var height = window.innerHeight - heightDiff + 11;
            canvas.writeAttribute({ width: window.innerWidth, height: height });
        }

        Event.observe(window, "resize", function() {
            sizeCanvas($("canvas"));
        });

        Event.observe(document, "dom:loaded", function() {
            sizeCanvas($("canvas"));

            scene = new Scene($("canvas"));

            tree = new HorizontalTree({ style: { backgroundColor: "rgb(76, 74, 65)",
                                                     backgroundColorOdd: "rgb(82, 80, 71)",
                                                     font: "9pt Tahoma",
                                                     color: "white" }});
            var renderer = new Label({ style: { border: new EmptyBorder({ size: 3 }) } });
            renderer.old_paint = renderer.paint;
            renderer.paint = function(ctx) {
                var d = this.d();

                if (this.selected) {
                    ctx.fillStyle = "rgb(177, 112, 20)";
                    ctx.fillRect(0, 0, d.b.w, 1);

                    var gradient = ctx.createLinearGradient(0, 0, 0, d.b.h);
                    gradient.addColorStop(0, "rgb(172, 102, 1)");
                    gradient.addColorStop(1, "rgb(219, 129, 1)");
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 1, d.b.w, d.b.h - 2);

                    ctx.fillStyle = "rgb(160, 95, 1)";
                    ctx.fillRect(0, d.b.h - 1, d.b.w, 1);
                }

                if (this.item.contents) {
                    renderer.styleContext(ctx);
                    var metrics = ctx.measureText(">");
                    ctx.fillText(">", d.b.w - metrics.width - 5, d.b.h / 2 + (metrics.ascent / 2) - 1);
                }
                
                this.old_paint(ctx);
            }
            tree.renderer = renderer;

            projects = new BespinProjectPanel();

            var topPanel = new Panel();
            topPanel.add([ projects, tree ]);
            topPanel.layout = function() {
                var d = this.d();
                projects.bounds = { x: d.i.l, y: d.i.t, width: projects.getPreferredWidth(d.b.h - d.i.h), height: d.b.h - d.i.h };
                tree.bounds = { x: projects.bounds.x + projects.bounds.width, y: d.i.t, width: d.b.w - d.i.w - projects.bounds.width, height: d.b.h - d.i.h };
            }
            projects.list.renderer = renderer;

            infoPanel = new ExpandingInfoPanel({ style: { backgroundColor: "rgb(61, 59, 52)" } });

            var splitPanel = new SplitPanel({ id: "splitPanel", attributes: {
                orientation: GTK.VERTICAL,
                regions: [ { size: "75%", contents: topPanel }, { size: "25%", contents: infoPanel } ]
            } });

            splitPanel.attributes.regions[0].label = new Label({
                    id: "foobar",
                    text: "Open Sessions",
                    style: {
                        color: "white",
                        font: "9pt Tahoma"
                    },
                    border: new EmptyBorder({ size: 4 })
            });

            scene.root.add(splitPanel);

            scene.render();

            scene.bus.bind("dblclick", tree, function() {
                var path = tree.getSelectedPath();
                if (path.length == 0) return;
                location.href = 'editor.html#project=' + currentProject + '&path=' + getFilePath(path);
            });

            scene.bus.bind("itemselected", projects.list, function(e) {
                currentProject = e.item;
                svr.list(e.item, null, displayFiles )
            });
        });

        var svr = new Server();
        var currentProject;

        function loggedIn(xhr) {
            svr.list(null, null, displayProjects);  // get projects
            svr.listOpen(displaySessions);   // get sessions
        }

        function notLoggedIn(xhr) {
            location.href = "index.html"; // take me home Scottie!
        }

        function displayFiles(files) {
            tree.setData(prepareFilesForTree(files));
        }

        function prepareFilesForTree(files) {
            if (files.length == 0) return [];

            var fdata = [];
            for (var i = 0; i < files.length; i++) {
                if (files[i].endsWith("/")) {
                    var name = files[i].substring(0, files[i].length - 1);
                    var contents = fetchFiles;
                    fdata.push({ name: name, contents: contents });
                } else {
                    fdata.push({ name: files[i] });
                }
            }

            return fdata;
        }

        function getFilePath(treePath) {
            var filepath = "";
            for (var i = 0; i < treePath.length; i++) filepath += treePath[i].name + ((i < treePath.length - 1) ? "/" : "");
            return filepath;
        }

        function fetchFiles(path, tree) {
            var filepath = currentProject + "/" + getFilePath(path);
            
            svr.list(filepath, null, function(files) {
                tree.updateData(path[path.length - 1], prepareFilesForTree(files));
            });
        }

        function displaySessions(sessions) {
            infoPanel.removeAll();

            for (var project in sessions) {
                for (var file in sessions[project]) {
                    var lastSlash = file.lastIndexOf("/");
                    var path = (lastSlash == -1) ? "" : file.substring(0, lastSlash);
                    var name = (lastSlash == -1) ? file : file.substring(lastSlash + 1);
                    infoPanel.add(new BespinSessionPanel({ filename: name, project: project, path: path }));
                }
            }
            scene.render();

            setTimeout(function() {
                svr.listOpen(displaySessions);   // get sessions
            }, 3000);
        }

        function displayProjects(projectItems) {
            for (var i = 0; i < projectItems.length; i++) {
                projectItems[i] = projectItems[i].substring(0, projectItems[i].length - 1);
            }
            projects.list.items = projectItems;
            scene.render();
        }

        function setupUI() {
            // get logged in name; if not logged in, display an error of some kind
            svr.currentuser(loggedIn, notLoggedIn);
        }
    </script>
</head>
<body onload="setupUI()">
    <div id="header">
        <img id="logo" src="images/logo.png" alt="Bespin" />
    </div>
    <div id="subheader">
        <div id="status">Dashboard</div>
    </div>
    <div id="filecanvas">
        <canvas id="canvas" moz-opaque="true">
        </canvas>
    </div>
    <div id="footer">
        <div id="prompt"><img src="images/icn_command.png" alt=">" /></div>
        <div id="commandlineParent"><input id="commandline" /></div>
    </div>
</body>
</html>