<!--
    ***** BEGIN LICENSE BLOCK *****
    Version: MPL 1.1

    The contents of this file are subject to the Mozilla Public License Version
    1.1 (the "License"); you may not use this file except in compliance with
    the License. You may obtain a copy of the License at
    http://www.mozilla.org/MPL/

    Software distributed under the License is distributed on an "AS IS" basis,
    WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
    for the specific language governing rights and limitations under the
    License.

    The Original Code is Bespin.

    The Initial Developer of the Original Code is Mozilla.
    Portions created by the Initial Developer are Copyright (C) 2009
    the Initial Developer. All Rights Reserved.

    Contributor(s):
        Bespin Team (bespin@mozilla.com)

    ***** END LICENSE BLOCK *****
-->

<!doctype html>
<html>
<head>
    <title>gtk test</title>
    <link type="text/css" rel="stylesheet" href="css/dashboard.css"/>
    <script type="text/javascript" src="js/external/prototype-1.6.0.3.js"></script>
    <script type="text/javascript" src="js/util/path.js"></script>
    <script type="text/javascript" src="js/client/server.js"></script>

    <script type="text/javascript" src="js/external/jstraits.js"></script>
    <script type="text/javascript" src="js/th/array_utils.js"></script>
    <script type="text/javascript" src="js/th/traits.js"></script>
    <script type="text/javascript" src="js/th/gtk.js"></script>
    <script type="text/javascript" src="js/th/models.js"></script>
    <script type="text/javascript" src="js/th/borders.js"></script>
    <script type="text/javascript" src="js/th/components.js"></script>
    <script type="text/javascript" src="js/client/dashboard.js"></script>
    <script type="text/javascript">
        var heightDiff;
        var projects;
        var scene;

        function sizeCanvas(canvas) {
            if (!heightDiff) {
                heightDiff = $("header").clientHeight + $("subheader").clientHeight + $("footer").clientHeight;
            }
            var height = window.innerHeight - heightDiff;
            canvas.writeAttribute({ width: window.innerWidth, height: height });
        }

        Event.observe(window, "resize", function() {
            sizeCanvas($("canvas"));
        });

        Event.observe(document, "dom:loaded", function() {
            sizeCanvas($("canvas"));

            scene = new Scene($("canvas"));

            var tree = new HorizontalTree({ style: { backgroundColor: "rgb(76, 74, 65)",
                                                     backgroundColorOdd: "rgb(82, 80, 71)",
                                                     font: "9pt Tahoma",
                                                     color: "white" }});
            var renderer = new Label({ style: { border: new EmptyBorder({ size: 3 }) } });
            renderer.old_paint = renderer.paint;
            renderer.paint = function(ctx) {
                var d = this.d();

                if (this.selected) {
                    ctx.fillStyle = "rgb(177, 112, 20)";
                    ctx.fillRect(0, 0, d.b.w, 1);

                    var gradient = ctx.createLinearGradient(0, 0, 0, d.b.h);
                    gradient.addColorStop(0, "rgb(172, 102, 1)");
                    gradient.addColorStop(1, "rgb(219, 129, 1)");
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 1, d.b.w, d.b.h - 2);

                    ctx.fillStyle = "rgb(160, 95, 1)";
                    ctx.fillRect(0, d.b.h - 1, d.b.w, 1);
                }
                
                this.old_paint(ctx);
            }
            tree.renderer = renderer;

            tree.setData([
                { name: "someFile.js" },
                { name: "anotherFile.js" },
                { name: "directory", contents: [
                    { name: "nestedFile.js" },
                    { name: "nestedDirectory", contents: [
                        { name: "finalFile.js" }
                    ]}
                ]},
                { name: "anotherDir", contents: [
                    { name: "justTwo.js" },
                    { name: "see.js" }
                ]}
            ]);


            projects = new BespinProjectPanel();

            var topPanel = new Panel();
            topPanel.add([ projects, tree ]);
            topPanel.layout = function() {
                var d = this.d();
                projects.bounds = { x: d.i.l, y: d.i.t, width: projects.getPreferredWidth(d.b.h - d.i.h), height: d.b.h - d.i.h };
                tree.bounds = { x: projects.bounds.x + projects.bounds.width, y: d.i.t, width: d.b.w - d.i.w - projects.bounds.width, height: d.b.h - d.i.h };
            }
            projects.list.renderer = renderer;

            var infoPanel = new ExpandingInfoPanel({ style: { backgroundColor: "rgb(61, 59, 52)" } });

            var splitPanel = new SplitPanel({ id: "splitPanel", attributes: {
                orientation: GTK.VERTICAL,
                regions: [ { size: "75%", contents: topPanel }, { size: "25%", contents: infoPanel } ]
            } });

            scene.root.add(splitPanel);

            scene.render();

            scene.bus.bind("dblclick", tree, function() { infoPanel.add(new BespinSessionPanel()); scene.render(); });

            //scene.bus.bind("itemselected", projects.list, 
        });

        var svr = new Server();
        var currentProject;
        var oldli;

        function toggleFiles(li) {
            if (oldli) {
                oldli.removeClassName("selected");
                oldli.addClassName("deselected");
            }

            var project = li.getAttribute("b_project");
            if (currentProject == project) {
                currentProject = null;
                hideFiles(li);
            } else {
                li.removeClassName("deselected");
                li.addClassName("selected");

                currentProject = project;

                var files = $('files');

                // check if files isn't already showing for some other project
                if (files.style.display == 'none') {
                    showFiles(li);
                }

                files.innerHTML = "";
                svr.list(project, null, displayFiles);  // get projects
            }

            oldli = li;
        }

        function showFiles(li) {
            $('files').show();
            $('graphs').style.left = '361px';
            $('graphs').style.borderLeft = 'none';
        }

        function hideFiles(li) {
            $('files').hide();
            $('graphs').style.left = '181px';
            $('graphs').style.borderLeft = '1px solid black';
        }

        function loggedIn(xhr) {
            svr.list(null, null, displayProjects);  // get projects
            //svr.listOpen(displaySessions);   // get sessions
        }

        function notLoggedIn(xhr) {
            location.href = "index.html"; // take me home Scottie!
        }

        function displayFiles(files) {
            if (files.length == 0) return;

            var filesNode = $('files');
            var ul = new Element("ul");
            filesNode.appendChild(ul);

            for (var i = 0; i < files.length; i++) {
                var fileNode = new Element("li");
                fileNode.appendChild(new Element("a", { 'href' : 'editor.html#project=' + currentProject + '&path=' + files[i] }).update(files[i]));
                ul.appendChild(fileNode);
            }
        }

        function displaySessions(sessions) {
            var sessionsNode = $("sessionslist");
            sessionsNode.innerHTML = "";

            for (var project in sessions) {
                var projectNode = new Element("li").update(project);
                sessionsNode.appendChild(projectNode);

                var projectContents = new Element("ul");
                projectNode.appendChild(projectContents);

                for (var file in sessions[project]) {
                    var fileNode = new Element("li");
                    projectContents.appendChild(fileNode);

                    var link = new Element("a", { 'href' : 'editor.html#project=' + project + '&path=' + file }).update(file);
                    fileNode.appendChild(link);
                }
            }
        }

        function displayProjects(projectItems) {
            for (var i = 0; i < projectItems.length; i++) {
                projectItems[i] = projectItems[i].substring(0, projectItems[i].length - 1);
            }
            projects.list.items = projectItems;
            scene.render();
        }

        function setupUI() {

            // get logged in name; if not logged in, display an error of some kind
            svr.currentuser(loggedIn, notLoggedIn);

            // get the projects for the user

            // add the projects to the UI

            // get the list of open sessions

            // add the open sessions to the UI


        }
    </script>
</head>
<body onload="setupUI()">
    <div id="header">
        <img id="logo" src="images/logo.png" alt="Bespin" />
    </div>
    <div id="subheader">
        <div id="status">Dashboard</div>
    </div>
    <div>
        <canvas id="canvas" moz-opaque="true">
        </canvas>
    </div>
    <div id="footer">
        <div id="prompt"><img src="images/icn_command.png" alt=">" /></div>
        <div id="commandlineParent"><input id="commandline" /></div>
    </div>
</body>
</html>